<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>myVM -> Home</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.ico') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/font-awesome.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/animate.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/hamburgers.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/select2.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/util.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<!--===============================================================================================-->
</head>
<body>
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark sticky-top">
		<a class="navbar-brand font-weight-bold" href="/home">Lista files</a>
		<a class="navbar-brand font-weight-bold" href="/antivirus">Statistiche Antivirus</a>
	</nav>
	<div class="container-filelist">
        <div class="container mt-3">
			<h1 class="text-center font-weight-bold" style="margin-bottom: 30px">Files osservati al momento</h1>
			<li class="list-group-item d-flex justify-content-between align-items-center" style="margin-top:10px">
				<h4 class="font-weight-bold">ID</h4><h4 class="font-weight-bold">NOME FILE</h4>
				<form id="upload-file" method="POST" enctype="multipart/form-data">
					<input  type="file" name="file">
					<input type="button" id="upload-file-btn" class="btn btn-success btn-md" value="Aggiungi">
				</form>
			</li>
			<ul class="list-group">
				{% for file in files %}
				<li id="file_{{file[0]}}"class="list-group-item d-flex justify-content-between align-items-center" style="margin-top:10px; cursor: pointer;" onclick="get_file_info($(this).children(':first').text())">
					<h5>{{file[0]}}</h5>
					<h5 style="width: 60%">{{file[1]}}</h5>
					
					{% if file[4] == 0 and file[5] != 0%}
                    			<div style="width: 20%" class="w3-light-grey w3-round-xlarge">
    						<div class="w3-container w3-green w3-round-xlarge" style="width:100%"><p>0/{{file[5]}}</p></div>
  					</div>
					{% endif %}
					{% if file[4] != 0 and file[5] != 0 %}
					<div style="width: 20%" class="w3-light-grey w3-round-xlarge">
                                                <div class="w3-container w3-red w3-round-xlarge" style="width:{{ (file[4]/file[5]) * 100}}%; min-width: 25%;"><p style="color:white">{{file[4]}}/{{file[5]}}</p></div>
					</div>
					{% endif %}
					<button type="button" class="close" aria-label="Close" onclick="remove_file($(this).prev().prev().prev().text())">
						<span aria-hidden="true">&times;</span>
					</button>
				</li>
				{% endfor %}
			</ul>
		</div>
	</div>


<!--===============================================================================================-->
	<script type="text/javascript" async="" src="../static/js/analytics.js"></script>
    <script src="../static/js/jquery-3.js" type="text/javascript"></script>
	<script src="../static/js/popper.js" type="text/javascript"></script>
	<script src="../static/js/bootstrap.js" type="text/javascript"></script>
	<script src="../static/js/select2.js" type="text/javascript"></script>
	<script src="../static/js/tilt.js" type="text/javascript"></script>
	<script type="text/javascript">
		$('.js-tilt').tilt({
			scale: 1.1
		})
	</script>
	<script src="../static/js/main.js" type="text/javascript"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<!--===============================================================================================-->


<script type="text/javascript">
function get_file_info(id_)  {
	window.location.replace("file?id=" + id_);
}

$('#upload-file-btn').click(function() {
	var form_data = new FormData($('#upload-file')[0]);

	$.ajax({
		type: 'POST',
		url: '/add',
		data: form_data,
		contentType: false,
		cache: false,
		processData: false,
		success: function(data) {
			if(data == "success")  {
				swal({
					title: "File caricato",
					text: "Potrebbe volerci un po' prima di vederlo in lista",
					icon: "success",
				})
			}
			else if(data == "too_many_files")  {
				swal({
					title: "File non caricato",
					text: "Troppi files in attesa di scan, provare più tardi",
					icon: "error",
				})
			}
			else if(data == "too_big")  {
				swal({
					title: "File non caricato",
					text: "File troppo grande, dimensione max: 100MB",
					icon: "error",
				})
			} 
			else if(data == "too_many_files_db")  {
				swal({
					title: "File non caricato",
					text: "Troppi files monitorati, cancellarne qualcuno",
					icon: "error",
				})
			}
			else if(data == "not_supported_format")  {
				swal({
					title: "File non caricato",
					text: "Formato file non supportato",
					icon: "error",
				})
			}
		},
		error: function(data) {
			swal({
				title: "C'è stato un errore",
				text: "Il file non è stato caricato, riprova",
				icon: "error",
			})
		},
	});
});

function remove_file(id_)  {
	swal({
		title: "Sicuro?",
		icon: "warning",
		buttons: true,
		dangerMode: true,
	}).then((willDelete) => {
		if (willDelete) {

			$.ajax({
				url: "rmv",
				type: "POST",
				data: {id: id_ }
			}).done(function(data) {
				if(data == "success")  {
					$('#file_' + id_).remove();
					swal("File cancellato dal sistema", {
						icon: "success",
					});
				}
				else if(data == "error")  {
					swal("C'è stato qualche errore cancellando il file", {
						icon: "error",
					});
				}
			})
		}
	});
	event.stopPropagation();
}
</script>
</body></html>
